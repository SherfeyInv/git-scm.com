---
### DO NOT EDIT! Generated by script/update-docs.rb

category: manual
section: documentation
subsection: manual
title: Git - multi-pack-index Documentation
docname: multi-pack-index
version: 2.50.0
aliases:
- "/docs/multi-pack-index/2.50.0/index.html"
---
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Git object directory contains a <em>pack</em> directory containing
packfiles (with suffix ".pack") and pack-indexes (with suffix
".idx"). The pack-indexes provide a way to lookup objects and
navigate to their offset within the pack, but these must come
in pairs with the packfiles. This pairing depends on the file
names, as the pack-index differs only in suffix with its pack-
file. While the pack-indexes provide fast lookup per packfile,
this performance degrades as the number of packfiles increases,
because abbreviations need to inspect every packfile and we are
more likely to have a miss on our most-recently-used packfile.
For some large repositories, repacking into a single packfile
is not feasible due to storage space or excessive repack times.</p>
</div>
<div class="paragraph">
<p>The multi-pack-index (MIDX for short) stores a list of objects
and their offsets into multiple packfiles. It contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A list of packfile names.</p>
</li>
<li>
<p>A sorted list of object IDs.</p>
</li>
<li>
<p>A list of metadata for the ith object ID including:</p>
<div class="ulist">
<ul>
<li>
<p>A value j referring to the jth packfile.</p>
</li>
<li>
<p>An offset within the jth packfile for the object.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If large offsets are required, we use another list of large
offsets similar to version 2 pack-indexes.</p>
<div class="ulist">
<ul>
<li>
<p>An optional list of objects in pseudo-pack order (used with MIDX bitmaps).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, we can provide O(log N) lookup time for any number
of packfiles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_details"><a class="anchor" href="#_design_details"></a>Design Details</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The MIDX is stored in a file named <em>multi-pack-index</em> in the
.git/objects/pack directory. This could be stored in the pack
directory of an alternate. It refers only to packfiles in that
same directory.</p>
</li>
<li>
<p>The core.multiPackIndex config setting must be on (which is the
default) to consume MIDX files.  Setting it to <span class='synopsis'><code>false</code></span> prevents
Git from reading a MIDX file, even if one exists.</p>
</li>
<li>
<p>The file format includes parameters for the object ID hash
function, so a future change of hash algorithm does not require
a change in format.</p>
</li>
<li>
<p>The MIDX keeps only one record per object ID. If an object appears
in multiple packfiles, then the MIDX selects the copy in the
preferred packfile, otherwise selecting from the most-recently
modified packfile.</p>
</li>
<li>
<p>If there exist packfiles in the pack directory not registered in
the MIDX, then those packfiles are loaded into the <span class='synopsis'><code>packed_git</code></span>
list and <span class='synopsis'><code>packed_git_mru</code></span> cache.</p>
</li>
<li>
<p>The pack-indexes (.idx files) remain in the pack directory so we
can delete the MIDX file, set core.midx to false, or downgrade
without any loss of information.</p>
</li>
<li>
<p>The MIDX file format uses a chunk-based approach (similar to the
commit-graph file) that allows optional data to be added.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_incremental_multi_pack_indexes"><a class="anchor" href="#_incremental_multi_pack_indexes"></a>Incremental multi-pack indexes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As repositories grow in size, it becomes more expensive to write a
multi-pack index (MIDX) that includes all packfiles. To accommodate
this, the "incremental multi-pack indexes" feature allows for combining
a "chain" of multi-pack indexes.</p>
</div>
<div class="paragraph">
<p>Each individual component of the chain need only contain a small number
of packfiles. Appending to the chain does not invalidate earlier parts
of the chain, so repositories can control how much time is spent
updating the MIDX chain by determining the number of packs in each layer
of the MIDX chain.</p>
</div>
<div class="sect2">
<h3 id="_design_state"><a class="anchor" href="#_design_state"></a>Design state</h3>
<div class="paragraph">
<p>At present, the incremental multi-pack indexes feature is missing two
important components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ability to rewrite earlier portions of the MIDX chain (i.e., to
"compact" some collection of adjacent MIDX layers into a single
MIDX). At present the only supported way of shrinking a MIDX chain
is to rewrite the entire chain from scratch without the <span class='synopsis'><code>--split</code></span>
flag.</p>
<div class="paragraph">
<p>There are no fundamental limitations that stand in the way of being able
to implement this feature. It is omitted from the initial implementation
in order to reduce the complexity, but will be added later.</p>
</div>
</li>
<li>
<p>Support for reachability bitmaps. The classic single MIDX
implementation does support reachability bitmaps (see the section
titled "multi-pack-index reverse indexes" in
<a href='{{< relurl "docs/gitformat-pack" >}}'>gitformat-pack[5]</a> for more details).</p>
<div class="paragraph">
<p>As above, there are no fundamental limitations that stand in the way of
extending the incremental MIDX format to support reachability bitmaps.
The design below specifically takes this into account, and support for
reachability bitmaps will be added in a future patch series. It is
omitted from the current implementation for the same reason as above.</p>
</div>
<div class="paragraph">
<p>In brief, to support reachability bitmaps with the incremental MIDX
feature, the concept of the pseudo-pack order is extended across each
layer of the incremental MIDX chain to form a concatenated pseudo-pack
order. This concatenation takes place in the same order as the chain
itself (in other words, the concatenated pseudo-pack order for a chain
<span class='synopsis'><code>{$H1,</code> <code>$H2,</code> <code>$H3}</code></span> would be the pseudo-pack order for <span class='synopsis'><code>$H1</code></span>, followed by
the pseudo-pack order for <span class='synopsis'><code>$H2</code></span>, followed by the pseudo-pack order for
<span class='synopsis'><code>$H3</code></span>).</p>
</div>
<div class="paragraph">
<p>The layout will then be extended so that each layer of the incremental
MIDX chain can write a <span class='synopsis'><code>*.bitmap</code></span>. The objects in each layer&#8217;s bitmap
are offset by the number of objects in the previous layers of the chain.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_file_layout"><a class="anchor" href="#_file_layout"></a>File layout</h3>
<div class="paragraph">
<p>Instead of storing a single <span class='synopsis'><code>multi-pack-index</code></span> file (with an optional
<span class='synopsis'><code>.rev</code></span> and <span class='synopsis'><code>.bitmap</code></span> extension) in <span class='synopsis'><code>$GIT_DIR/objects/pack</code></span>, incremental
MIDXs are stored in the following layout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$GIT_DIR/objects/pack/multi-pack-index.d/
$GIT_DIR/objects/pack/multi-pack-index.d/multi-pack-index-chain
$GIT_DIR/objects/pack/multi-pack-index.d/multi-pack-index-$H1.midx
$GIT_DIR/objects/pack/multi-pack-index.d/multi-pack-index-$H2.midx
$GIT_DIR/objects/pack/multi-pack-index.d/multi-pack-index-$H3.midx</pre>
</div>
</div>
<div class="paragraph">
<p>The <span class='synopsis'><code>multi-pack-index-chain</code></span> file contains a list of the incremental
MIDX files in the chain, in order. The above example shows a chain whose
<span class='synopsis'><code>multi-pack-index-chain</code></span> file would contain the following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$H1
$H2
$H3</pre>
</div>
</div>
<div class="paragraph">
<p>The <span class='synopsis'><code>multi-pack-index-$H1.midx</code></span> file contains the first layer of the
multi-pack-index chain. The <span class='synopsis'><code>multi-pack-index-$H2.midx</code></span> file contains
the second layer of the chain, and so on.</p>
</div>
<div class="paragraph">
<p>When both an incremental- and non-incremental MIDX are present, the
non-incremental MIDX is always read first.</p>
</div>
</div>
<div class="sect2">
<h3 id="_object_positions_for_incremental_midxs"><a class="anchor" href="#_object_positions_for_incremental_midxs"></a>Object positions for incremental MIDXs</h3>
<div class="paragraph">
<p>In the original multi-pack-index design, we refer to objects via their
lexicographic position (by object IDs) within the repository&#8217;s singular
multi-pack-index. In the incremental multi-pack-index design, we refer
to objects via their index into a concatenated lexicographic ordering
among each component in the MIDX chain.</p>
</div>
<div class="paragraph">
<p>If <span class='synopsis'><code>objects_nr</code>()</span> is a function that returns the number of objects in a
given MIDX layer, then the index of an object at lexicographic position
<span class='synopsis'><code>i</code></span> within, say, $H3 is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>objects_nr($H2) + objects_nr($H1) + i</pre>
</div>
</div>
<div class="paragraph">
<p>(in the C implementation, this is often computed as <span class='synopsis'><em>i +
</em>
<em>m-&gt;num_objects_in_base</em></span>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_pseudo_pack_order_for_incremental_midxs"><a class="anchor" href="#_pseudo_pack_order_for_incremental_midxs"></a>Pseudo-pack order for incremental MIDXs</h3>
<div class="paragraph">
<p>The original implementation of multi-pack reachability bitmaps defined
the pseudo-pack order in <a href='{{< relurl "docs/gitformat-pack" >}}'>gitformat-pack[5]</a> (see the section
titled "multi-pack-index reverse indexes") roughly as follows:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In short, a MIDX&#8217;s pseudo-pack is the de-duplicated concatenation of
objects in packs stored by the MIDX, laid out in pack order, and the
packs arranged in MIDX order (with the preferred pack coming first).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In the incremental MIDX design, we extend this definition to include
objects from multiple layers of the MIDX chain. The pseudo-pack order
for incremental MIDXs is determined by concatenating the pseudo-pack
ordering for each layer of the MIDX chain in order. Formally two objects
<span class='synopsis'><code>o1</code></span> and <span class='synopsis'><code>o2</code></span> are compared as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If <span class='synopsis'><code>o1</code></span> appears in an earlier layer of the MIDX chain than <span class='synopsis'><code>o2</code></span>, then
<span class='synopsis'><code>o1</code></span> sorts ahead of <span class='synopsis'><code>o2</code></span>.</p>
</li>
<li>
<p>Otherwise, if <span class='synopsis'><code>o1</code></span> and <span class='synopsis'><code>o2</code></span> appear in the same MIDX layer, and that
MIDX layer has no base, then if one of <span class='synopsis'><code>pack</code>(<code>o1</code>)</span> and <span class='synopsis'><code>pack</code>(<code>o2</code>)</span> is
preferred and the other is not, then the preferred one sorts ahead of
the non-preferred one. If there is a base layer (i.e. the MIDX layer
is not the first layer in the chain), then if <span class='synopsis'><code>pack</code>(<code>o1</code>)</span> appears
earlier in that MIDX layer&#8217;s pack order, then <span class='synopsis'><code>o1</code></span> sorts ahead of
<span class='synopsis'><code>o2</code></span>. Likewise if <span class='synopsis'><code>pack</code>(<code>o2</code>)</span> appears earlier, then the opposite is
true.</p>
</li>
<li>
<p>Otherwise, <span class='synopsis'><code>o1</code></span> and <span class='synopsis'><code>o2</code></span> appear in the same pack, and thus in the
same MIDX layer. Sort <span class='synopsis'><code>o1</code></span> and <span class='synopsis'><code>o2</code></span> by their offset within their
containing packfile.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the preferred pack is a property of the MIDX chain, not the
individual layers themselves. Fundamentally we could introduce a
per-layer preferred pack, but this is less relevant now that we can
perform multi-pack reuse across the set of packs in a MIDX.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reachability_bitmaps_and_incremental_midxs"><a class="anchor" href="#_reachability_bitmaps_and_incremental_midxs"></a>Reachability bitmaps and incremental MIDXs</h3>
<div class="paragraph">
<p>Each layer of an incremental MIDX chain may have its objects (and the
objects from any previous layer in the same MIDX chain) represented in
its own <span class='synopsis'><code>*.bitmap</code></span> file.</p>
</div>
<div class="paragraph">
<p>The structure of a <span class='synopsis'><code>*.bitmap</code></span> file belonging to an incremental MIDX
chain is identical to that of a non-incremental MIDX bitmap, or a
classic single-pack bitmap. Since objects are added to the end of the
incremental MIDX&#8217;s pseudo-pack order (see above), it is possible to
extend a bitmap when appending to the end of a MIDX chain.</p>
</div>
<div class="paragraph">
<p>(Note: it is possible likewise to compress a contiguous sequence of MIDX
incremental layers, and their <span class='synopsis'><code>*.bitmap</code></span> files into a single layer and
<span class='synopsis'><code>*.bitmap</code></span>, but this is not yet implemented.)</p>
</div>
<div class="paragraph">
<p>The object positions used are global within the pseudo-pack order, so
subsequent layers will have, for example, <span class='synopsis'><em>m-&gt;num_objects_in_base</em></span>
number of <span class='synopsis'><code>0</code></span> bits in each of their four type bitmaps. This follows from
the fact that we only write type bitmap entries for objects present in
the layer immediately corresponding to the bitmap).</p>
</div>
<div class="paragraph">
<p>Note also that only the bitmap pertaining to the most recent layer in an
incremental MIDX chain is used to store reachability information about
the interesting and uninteresting objects in a reachability query.
Earlier bitmap layers are only used to look up commit and pseudo-merge
bitmaps from that layer, as well as the type-level bitmaps for objects
in that layer.</p>
</div>
<div class="paragraph">
<p>To simplify the implementation, type-level bitmaps are iterated
simultaneously, and their results are OR&#8217;d together to avoid recursively
calling internal bitmap functions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_future_work"><a class="anchor" href="#_future_work"></a>Future Work</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>If the multi-pack-index is extended to store a "stable object order"
(a function Order(hash) = integer that is constant for a given hash,
even as the multi-pack-index is updated) then MIDX bitmaps could be
updated independently of the MIDX.</p>
</li>
<li>
<p>Packfiles can be marked as "special" using empty files that share
the initial name but replace ".pack" with ".keep" or ".promisor".
We can add an optional chunk of data to the multi-pack-index that
records flags of information about the packfiles. This allows new
states, such as <em>repacked</em> or <em>redeltified</em>, that can help with
pack maintenance in a multi-pack environment. It may also be
helpful to organize packfiles by object type (commit, tree, blob,
etc.) and use this metadata to help that maintenance.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_related_links"><a class="anchor" href="#_related_links"></a>Related Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>[0] <a href="https://bugs.chromium.org/p/git/issues/detail?id=6" class="bare">https://bugs.chromium.org/p/git/issues/detail?id=6</a>
    Chromium work item for: Multi-Pack Index (MIDX)</p>
</div>
<div class="paragraph">
<p>[1] <a href="https://lore.kernel.org/git/20180107181459.222909-1-dstolee@microsoft.com/" class="bare">https://lore.kernel.org/git/20180107181459.222909-1-dstolee@microsoft.com/</a>
    An earlier RFC for the multi-pack-index feature</p>
</div>
<div class="paragraph">
<p>[2] <a href="https://lore.kernel.org/git/alpine.DEB.2.20.1803091557510.23109@alexmv-linux/" class="bare">https://lore.kernel.org/git/alpine.DEB.2.20.1803091557510.23109@alexmv-linux/</a>
    Git Merge 2018 Contributor&#8217;s summit notes (includes discussion of MIDX)</p>
</div>
</div>
</div>