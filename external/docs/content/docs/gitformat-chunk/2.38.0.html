---
### DO NOT EDIT! Generated by script/update-docs.rb

category: manual
section: documentation
subsection: manual
title: Git - gitformat-chunk Documentation
docname: gitformat-chunk
version: 2.38.0
aliases:
- "/docs/gitformat-chunk/2.38.0/index.html"
- "/docs/gitformat-chunk/2.38.1/index.html"
- "/docs/gitformat-chunk/2.38.2/index.html"
- "/docs/gitformat-chunk/2.38.3/index.html"
- "/docs/gitformat-chunk/2.38.4/index.html"
- "/docs/gitformat-chunk/2.38.5/index.html"
- "/docs/gitformat-chunk/2.39.0/index.html"
- "/docs/gitformat-chunk/2.39.1/index.html"
- "/docs/gitformat-chunk/2.39.2/index.html"
- "/docs/gitformat-chunk/2.39.3/index.html"
- "/docs/gitformat-chunk/2.39.4/index.html"
- "/docs/gitformat-chunk/2.39.5/index.html"
- "/docs/gitformat-chunk/2.40.0/index.html"
- "/docs/gitformat-chunk/2.40.1/index.html"
- "/docs/gitformat-chunk/2.40.2/index.html"
- "/docs/gitformat-chunk/2.40.3/index.html"
- "/docs/gitformat-chunk/2.40.4/index.html"
- "/docs/gitformat-chunk/2.41.0/index.html"
- "/docs/gitformat-chunk/2.41.1/index.html"
- "/docs/gitformat-chunk/2.41.2/index.html"
- "/docs/gitformat-chunk/2.41.3/index.html"
- "/docs/gitformat-chunk/2.42.0/index.html"
- "/docs/gitformat-chunk/2.42.1/index.html"
- "/docs/gitformat-chunk/2.42.2/index.html"
- "/docs/gitformat-chunk/2.42.3/index.html"
- "/docs/gitformat-chunk/2.42.4/index.html"
---
<div class="sect1">
<h2 id="_name"><a class="anchor" href="#_name"></a>NAME</h2>
<div class="sectionbody">
<div class="paragraph">
<p>gitformat-chunk - Chunk-based file formats</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_synopsis"><a class="anchor" href="#_synopsis"></a>SYNOPSIS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Used by <a href='{{< relurl "docs/gitformat-commit-graph" >}}'>gitformat-commit-graph[5]</a> and the "MIDX" format (see
the pack format documentation in <a href='{{< relurl "docs/gitformat-pack" >}}'>gitformat-pack[5]</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_description"><a class="anchor" href="#_description"></a>DESCRIPTION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some file formats in Git use a common concept of "chunks" to describe
sections of the file. This allows structured access to a large file by
scanning a small "table of contents" for the remaining data. This common
format is used by the <span class='synopsis'><code>commit-graph</code></span> and <span class='synopsis'><code>multi-pack-index</code></span> files. See
the <span class='synopsis'><code>multi-pack-index</code></span> format in <a href='{{< relurl "docs/gitformat-pack" >}}'>gitformat-pack[5]</a> and
the <span class='synopsis'><code>commit-graph</code></span> format in <a href='{{< relurl "docs/gitformat-commit-graph" >}}'>gitformat-commit-graph[5]</a> for
how they use the chunks to describe structured data.</p>
</div>
<div class="paragraph">
<p>A chunk-based file format begins with some header information custom to
that format. That header should include enough information to identify
the file type, format version, and number of chunks in the file. From this
information, that file can determine the start of the chunk-based region.</p>
</div>
<div class="paragraph">
<p>The chunk-based region starts with a table of contents describing where
each chunk starts and ends. This consists of (C+1) rows of 12 bytes each,
where C is the number of chunks. Consider the following table:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>| Chunk ID (4 bytes) | Chunk Offset (8 bytes) |
|--------------------|------------------------|
| ID[0]              | OFFSET[0]              |
| ...                | ...                    |
| ID[C]              | OFFSET[C]              |
| 0x0000             | OFFSET[C+1]            |</pre>
</div>
</div>
<div class="paragraph">
<p>Each row consists of a 4-byte chunk identifier (ID) and an 8-byte offset.
Each integer is stored in network-byte order.</p>
</div>
<div class="paragraph">
<p>The chunk identifier <span class='synopsis'><code>ID</code>[<code>i</code>]</span> is a label for the data stored within this
fill from <span class='synopsis'><code>OFFSET</code>[<code>i</code>]</span> (inclusive) to <span class='synopsis'><code>OFFSET</code>[<code>i+1</code>]</span> (exclusive). Thus, the
size of the <span class='synopsis'><code>i</code><code>th</code> <code>chunk</code> <code>is</code> <code>equal</code> <code>to</code> <code>the</code> <code>difference</code> <code>between</code> <code>OFFSET</code>[<code>i+1</code>]</span>
and <span class='synopsis'><code>OFFSET</code>[<code>i</code>]</span>. This requires that the chunk data appears contiguously
in the same order as the table of contents.</p>
</div>
<div class="paragraph">
<p>The final entry in the table of contents must be four zero bytes. This
confirms that the table of contents is ending and provides the offset for
the end of the chunk-based data.</p>
</div>
<div class="paragraph">
<p>Note: The chunk-based format expects that the file contains <em>at least</em> a
trailing hash after <span class='synopsis'><code>OFFSET</code>[<code>C+1</code>]</span>.</p>
</div>
<div class="paragraph">
<p>Functions for working with chunk-based file formats are declared in
<span class='synopsis'><code>chunk-format.h</code></span>. Using these methods provide extra checks that assist
developers when creating new file formats.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_chunk_based_file_formats"><a class="anchor" href="#_writing_chunk_based_file_formats"></a>Writing chunk-based file formats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To write a chunk-based file format, create a <span class='synopsis'><code>struct</code> <code>chunkfile</code></span> by
calling <span class='synopsis'><code>init_chunkfile</code>()</span> and pass a <span class='synopsis'><code>struct</code> <code>hashfile</code></span> pointer. The
caller is responsible for opening the <span class='synopsis'><code>hashfile</code></span> and writing header
information so the file format is identifiable before the chunk-based
format begins.</p>
</div>
<div class="paragraph">
<p>Then, call <span class='synopsis'><code>add_chunk</code>()</span> for each chunk that is intended for write. This
populates the <span class='synopsis'><code>chunkfile</code></span> with information about the order and size of
each chunk to write. Provide a <span class='synopsis'><code>chunk_write_fn</code></span> function pointer to
perform the write of the chunk data upon request.</p>
</div>
<div class="paragraph">
<p>Call <span class='synopsis'><code>write_chunkfile</code>()</span> to write the table of contents to the <span class='synopsis'><code>hashfile</code></span>
followed by each of the chunks. This will verify that each chunk wrote
the expected amount of data so the table of contents is correct.</p>
</div>
<div class="paragraph">
<p>Finally, call <span class='synopsis'><code>free_chunkfile</code>()</span> to clear the <span class='synopsis'><code>struct</code> <code>chunkfile</code></span> data. The
caller is responsible for finalizing the <span class='synopsis'><code>hashfile</code></span> by writing the trailing
hash and closing the file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reading_chunk_based_file_formats"><a class="anchor" href="#_reading_chunk_based_file_formats"></a>Reading chunk-based file formats</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To read a chunk-based file format, the file must be opened as a
memory-mapped region. The chunk-format API expects that the entire file
is mapped as a contiguous memory region.</p>
</div>
<div class="paragraph">
<p>Initialize a <span class='synopsis'><code>struct</code> <code>chunkfile</code></span> pointer with <span class='synopsis'><code>init_chunkfile</code>(<code>NULL</code>)</span>.</p>
</div>
<div class="paragraph">
<p>After reading the header information from the beginning of the file,
including the chunk count, call <span class='synopsis'><code>read_table_of_contents</code>()</span> to populate
the <span class='synopsis'><code>struct</code> <code>chunkfile</code></span> with the list of chunks, their offsets, and their
sizes.</p>
</div>
<div class="paragraph">
<p>Extract the data information for each chunk using <span class='synopsis'><code>pair_chunk</code>()</span> or
<span class='synopsis'><code>read_chunk</code>()</span>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class='synopsis'><code>pair_chunk</code>()</span> assigns a given pointer with the location inside the
memory-mapped file corresponding to that chunk&#8217;s offset. If the chunk
does not exist, then the pointer is not modified.</p>
</li>
<li>
<p><span class='synopsis'><code>read_chunk</code>()</span> takes a <span class='synopsis'><code>chunk_read_fn</code></span> function pointer and calls it
with the appropriate initial pointer and size information. The function
is not called if the chunk does not exist. Use this method to read chunks
if you need to perform immediate parsing or if you need to execute logic
based on the size of the chunk.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After calling these methods, call <span class='synopsis'><code>free_chunkfile</code>()</span> to clear the
<span class='synopsis'><code>struct</code> <code>chunkfile</code></span> data. This will not close the memory-mapped region.
Callers are expected to own that data for the timeframe the pointers into
the region are needed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These file formats use the chunk-format API, and can be used as examples
for future formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>commit-graph:</strong> see <span class='synopsis'><code>write_commit_graph_file</code>()</span> and <span class='synopsis'><code>parse_commit_graph</code>()</span>
in <span class='synopsis'><code>commit-graph.c</code></span> for how the chunk-format API is used to write and
parse the commit-graph file format documented in
the commit-graph file format in <a href='{{< relurl "docs/gitformat-commit-graph" >}}'>gitformat-commit-graph[5]</a>.</p>
</li>
<li>
<p><strong>multi-pack-index:</strong> see <span class='synopsis'><code>write_midx_internal</code>()</span> and <span class='synopsis'><code>load_multi_pack_index</code>()</span>
in <span class='synopsis'><code>midx.c</code></span> for how the chunk-format API is used to write and
parse the multi-pack-index file format documented in
the multi-pack-index file format section of <a href='{{< relurl "docs/gitformat-pack" >}}'>gitformat-pack[5]</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git"><a class="anchor" href="#_git"></a>GIT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part of the <a href='{{< relurl "docs/git" >}}'>git[1]</a> suite</p>
</div>
</div>
</div>